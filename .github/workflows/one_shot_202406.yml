name: backfill month and merge gold into docs

on:
  workflow_dispatch:
    inputs:
      year:
        description: "Anno (es: 2024)"
        required: true
        default: "2024"
      month:
        description: "Mese (01-12)"
        required: true
        default: "06"

permissions:
  contents: write

jobs:
  backfill:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas pyarrow duckdb requests pyyaml
          fi

      - name: Compute start and end of month
        id: daterange
        run: |
          python - <<'PY'
          import calendar
          import os
          y = int(os.environ["Y"])
          m = int(os.environ["M"])
          last = calendar.monthrange(y, m)[1]
          start = f"{y:04d}-{m:02d}-01"
          end = f"{y:04d}-{m:02d}-{last:02d}"
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"start={start}\n")
            f.write(f"end={end}\n")
          print("start", start, "end", end)
          PY
        env:
          Y: ${{ inputs.year }}
          M: ${{ inputs.month }}

      - name: Build silver for selected month
        run: |
          python -m scripts.transform_silver --start "${{ steps.daterange.outputs.start }}" --end "${{ steps.daterange.outputs.end }}"

      - name: Build gold tables
        run: |
          python -m scripts.build_gold

      - name: Build stations dimension
        run: |
          python -m scripts.build_station_dim

      - name: Merge gold into docs/data without overwriting history
        run: |
          python - <<'PY'
          from pathlib import Path
          import pandas as pd

          docs_data = Path("docs/data")
          docs_data.mkdir(parents=True, exist_ok=True)

          def pick_key(cols):
            for c in ("giorno", "mese", "date", "month"):
              if c in cols:
                return c
            return cols[0]

          def merge_csv(existing_path: Path, new_path: Path):
            new_df = pd.read_csv(new_path)
            key = pick_key(list(new_df.columns))
            if existing_path.exists():
              old_df = pd.read_csv(existing_path)
              if key in old_df.columns and key in new_df.columns:
                df = pd.concat([old_df, new_df], ignore_index=True)
                df = df.drop_duplicates(subset=[key], keep="last")
                try:
                  df = df.sort_values(key)
                except Exception:
                  pass
              else:
                df = pd.concat([old_df, new_df], ignore_index=True)
            else:
              df = new_df
            df.to_csv(existing_path, index=False)

          gold_dir = Path("data/gold")
          if not gold_dir.exists():
            raise SystemExit("data/gold non trovato, build_gold non ha prodotto output")

          for p in gold_dir.glob("*.csv"):
            merge_csv(docs_data / p.name, p)

          stations_src = Path("site/data/stations_dim.csv")
          if stations_src.exists():
            merge_csv(docs_data / "stations_dim.csv", stations_src)

          Path("docs/.nojekyll").touch()
          print("merged files:", len(list(docs_data.glob("*.csv"))))
          PY

      - name: Commit and push published datasets
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/data docs/.nojekyll
          git commit -m "Backfill ${{ inputs.year }}-${{ inputs.month }} (merge)" || echo "No changes"
          git push
